/*
 * r_bcd_ai.c
 *
 *  Created on: 2018/05/18
 *      Author: 16194PP29
 */

/******************************************************************************
Includes   <System Includes> , "Project Includes"
******************************************************************************/
#include <stdio.h>
#include <string.h>
#include <stdint.h>

#include "perform.h"
#include "r_typedefs.h"
#include "r_bcd_ai.h"
#include "r_bcd_main.h"
#include "r_bcd_drp.h"


#include "AI/Typedef.h"
#include "AI/layer_graph.h"
//#include "AI/input_image_gray.h"


TPrecision* dnn_compute(TPrecision* input_img);

/******************************************************************************
Private global variables and functions
******************************************************************************/

#ifdef R_BCD_BAYER_RGB
	static TPrecision input_img[R_BCD_AI_INPUT_X * R_BCD_AI_INPUT_Y * 3]  __attribute__ ((section("ImageWork_RAM")));
#else
	static TPrecision input_img[R_BCD_AI_INPUT_X * R_BCD_AI_INPUT_Y];
#endif

/******************************************************************************
* Function Name: R_BCD_AIGetAddress
* Description  : AI func
* Arguments    : -
* Return Value : address of the frame buffer
******************************************************************************/
float R_BCD_AI(unsigned char *inputdata)
{
#if 1
	TPrecision *ary;

#ifdef R_BCD_BAYER_RGB
	for(int i = 0; i < R_BCD_AI_INPUT_X * R_BCD_AI_INPUT_Y * 3; i++)
	{
		input_img[i] = (TPrecision)inputdata[i] / 255.0;
//		input_img[i] = (TPrecision)inputdata[i];
	}
#else
	for(int i = 0; i < R_BCD_AI_INPUT_X * R_BCD_AI_INPUT_Y; i++)
	{
//		input_img[i] = (TPrecision)inputdata[i] / 255.0;
		input_img[i] = (TPrecision)inputdata[i];
	}
#endif


	//R_BCD_SystemTimerStart(DRP_TIME_AI);
	ary = (TPrecision*)(intptr_t)dnn_compute(input_img);
	//R_BCD_SystemTimerEnd(DRP_TIME_AI);

	return ary[1];
#else
	return 0;
#endif
}
#if 0
// Standard size
#define HEIGHT_STD 28
#define WIDTH_STD 28

int AI_main(void)
{
	int cnt = 0;

	// 4.png 28*28
//	unsigned char input_img[] = { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 8, 5, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 30, 82, 60, 15, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 89, 201, 156, 43, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 29, 116, 193, 122, 28, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 26, 94, 176, 175, 71, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 30, 97, 175, 176, 95, 23, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 45, 132, 193, 181, 96, 26, 2, 0, 0, 0, 2, 7, 4, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 42, 152, 228, 222, 124, 30, 2, 0, 0, 0, 3, 30, 75, 42, 8, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 13, 107, 227, 230, 152, 44, 3, 0, 0, 0, 1, 25, 112, 201, 117, 23, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 40, 145, 231, 154, 48, 4, 0, 0, 0, 0, 7, 71, 185, 189, 84, 13, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 36, 124, 200, 135, 46, 5, 0, 0, 0, 0, 1, 26, 122, 214, 150, 42, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 28, 118, 209, 156, 55, 7, 0, 0, 0, 0, 0, 7, 70, 186, 191, 86, 14, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 14, 86, 192, 200, 100, 26, 11, 10, 10, 10, 10, 11, 25, 116, 218, 156, 48, 10, 5, 1, 0, 0, 0, 0, 0, 0, 0, 4, 49, 166, 226, 179, 125, 107, 106, 106, 106, 106, 106, 109, 131, 192, 226, 148, 84, 73, 59, 18, 1, 0, 0, 0, 0, 0, 0, 7, 78, 214, 235, 227, 221, 221, 221, 221, 221, 221, 221, 223, 234, 246, 231, 203, 191, 189, 171, 60, 5, 0, 0, 0, 0, 0, 0, 2, 31, 105, 155, 156, 154, 154, 154, 154, 154, 154, 156, 176, 226, 247, 221, 195, 190, 189, 171, 60, 5, 0, 0, 0, 0, 0, 0, 0, 3, 16, 34, 38, 38, 38, 38, 38, 38, 38, 49, 132, 234, 234, 147, 81, 73, 72, 59, 18, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 3, 4, 4, 4, 4, 4, 4, 5, 32, 143, 234, 162, 50, 9, 7, 6, 5, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 74, 197, 212, 101, 11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 104, 227, 227, 106, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9, 94, 208, 200, 78, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 15, 110, 218, 156, 42, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 26, 137, 221, 127, 24, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 16, 115, 220, 145, 32, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9, 89, 206, 131, 29, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 28, 76, 44, 9, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 7, 4, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 };
	// 2.png 28*28
	unsigned char input_img[] = { 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 22, 39, 46, 45, 47, 47, 34, 11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 15, 59, 115, 145, 153, 151, 154, 155, 123, 57, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 59, 162, 228, 227, 215, 213, 215, 218, 201, 136, 55, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 4, 82, 194, 221, 159, 113, 108, 108, 110, 157, 191, 145, 41, 2, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 40, 97, 104, 52, 19, 17, 17, 17, 88, 188, 194, 79, 8, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 9, 12, 0, 0, 0, 0, 0, 43, 155, 207, 117, 21, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 3, 1, 1, 21, 127, 209, 147, 36, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0, 12, 114, 207, 158, 43, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 16, 122, 211, 151, 37, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 2, 1, 2, 52, 170, 229, 138, 25, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 2, 2, 2, 2, 1, 2, 2, 0, 9, 106, 219, 222, 103, 12, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 3, 0, 3, 46, 163, 232, 172, 49, 2, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 9, 10, 7, 1, 0, 3, 45, 140, 224, 209, 105, 11, 0, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 41, 94, 121, 118, 99, 40, 5, 34, 123, 215, 219, 135, 40, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 2, 23, 73, 125, 180, 208, 209, 195, 129, 88, 126, 194, 200, 132, 49, 5, 0, 0, 1, 1, 2, 2, 1, 0, 0, 0, 0, 0, 7, 70, 174, 203, 182, 161, 179, 223, 218, 203, 204, 185, 109, 36, 2, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 2, 0, 14, 105, 229, 224, 121, 52, 100, 208, 254, 254, 207, 116, 31, 0, 0, 2, 1, 1, 0, 1, 7, 11, 4, 0, 0, 0, 2, 0, 16, 111, 224, 193, 91, 69, 151, 226, 241, 246, 215, 127, 40, 6, 1, 0, 0, 0, 0, 30, 88, 114, 54, 6, 0, 0, 2, 0, 18, 108, 210, 179, 140, 167, 199, 158, 127, 159, 207, 203, 148, 92, 44, 16, 15, 15, 35, 111, 203, 211, 95, 12, 0, 1, 2, 0, 20, 115, 228, 226, 222, 209, 146, 55, 24, 56, 137, 212, 232, 201, 149, 117, 118, 119, 144, 196, 227, 178, 70, 7, 0, 1, 2, 0, 16, 102, 218, 245, 225, 144, 44, 0, 0, 3, 40, 117, 194, 229, 225, 212, 213, 215, 214, 191, 133, 61, 14, 0, 0, 0, 0, 0, 3, 44, 112, 138, 109, 47, 3, 0, 1, 1, 1, 19, 70, 139, 166, 155, 149, 149, 126, 79, 30, 4, 0, 0, 0, 0, 0, 0, 0, 5, 17, 24, 15, 3, 0, 1, 1, 2, 0, 0, 6, 35, 50, 44, 39, 37, 24, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 3, 2, 3, 2, 0, 0, 0, 0, 0, 1, 2, 1, 1, 1, 1, 2, 2, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};

	TPrecision input_img_normal[HEIGHT_STD * WIDTH_STD] = {};

	// Normalize
	for(int y = 0; y < HEIGHT_STD; y++)
	{
		for(int x = 0; x < WIDTH_STD; x++)
		{
			input_img_normal[cnt] = input_img[WIDTH_STD * y + x]/255.0;
			cnt++;
		}
	}

	TPrecision *prediction;

	// Inference
	prediction = (TPrecision*) dnn_compute(input_img_normal);

	for(int i=0;i<10;i++)
	{
		printf("class[%d] = %f\n", i, prediction[i]);
	}


	return 0;
}
#endif
